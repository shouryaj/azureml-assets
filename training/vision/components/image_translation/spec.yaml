$schema: https://azuremlschemas.azureedge.net/latest/commandComponent.schema.json
type: command

description: Convert automl settings to HD sweep. [Learn More](https://aka.ms/built-in-vision-components)

name: automl_settings_convert
display_name: AutoML Settings Converter (Private Preview)
version: 0.0.1-preview

inputs:
  training_data:
    description: Training data
    type: mltable
  validation_data:
    description: Validation data
    type: mltable
    optional: true
  timeout_minutes:
    description: Timeout
    type: integer
    optional: true
  max_trials:
    description: Max trials
    type: integer
    optional: true
    default: 1
    min: 0
    max: 1000
  max_concurrent_trials:
    description: Max concurrent trials
    type: integer
    optional: true
  sampling_algorithm:
    description: Sampling algo Type
    type: string
    optional: true
    default: Random
    enum: ['Random', 'Grid', 'Bayesian']
  early_termination:
    description: Early termination policy type
    type: string
    optional: true
    default: Bandit
    enum: ['Bandit', 'MedianStopping', 'TruncationSelection']  
  model_name:
    description: Model name
    type: string
    default: yolov5
    enum: ['yolov5', 'fasterrcnn_resnet18_fpn', 'fasterrcnn_resnet34_fpn', 'fasterrcnn_resnet50_fpn', 'fasterrcnn_resnet101_fpn', 'fasterrcnn_resnet152_fpn', 'retinanet_resnet50_fpn']
  learning_rate:
    description: Initial learning rate
    type: number
    optional: true
    min: 0
    max: 1
  number_of_epochs:
    description: Number of training epochs
    type: integer
    optional: true
    min: 1
  optimizer:
    description: Type of optimizer
    type: string
    default: sgd
    enum: ['sgd', 'adam', 'adamw']  
  yolov5_model_size:
    description: '(This setting only applies when training the yolov5 model.) Model size for yolov5. Note: training run may get into CUDA OOM if the model size is too big.'
    type: string
    default: medium
    enum: ['small', 'medium', 'large', 'xlarge']
  yolov5_img_size:
    description: '(This setting only applies when training the yolov5 model.) Image size for train and validation. Note: training run may get into CUDA OOM if the model size is too big.'
    type: integer
    default: 640
    min: 1
  min_size:
    description: '(This setting only applies when not training the yolov5 model.) Minimum size of the image to be rescaled before feeding it to the backbone. Note: training run may get into CUDA OOM if the size is too big.'
    type: integer
    default: 600
    min: 1
  max_size:
    description: '(This setting only applies when not training the yolov5 models.) Maximum size of the image to be rescaled before feeding it to the backbone. Note: training run may get into CUDA OOM if the size is too big.'
    type: integer
    default: 1333
    min: 1
  training_batch_size:
    description: Training batch size.
    type: integer
    optional: true
    min: 1
  validation_batch_size:
    description: Validation batch size.
    type: integer
    optional: true
    min: 1
  weight_decay:
    description: Value of weight decay used by the optimizer.
    type: number
    default: 0.0001
    min: 0
    max: 1

outputs:
  sweep_json:
    description: Json String.
    type: string

code: ../src

environment: azureml:AzureML-AutoML-DNN-Vision-GPU:98

command: >-
  python -m image_translation.run
  --training_data ${{inputs.training_data}}
  $[[--validation_data ${{inputs.validation_data}}]]
  $[[--timeout_minutes ${{inputs.timeout_minutes}}]]
  $[[--max_trials ${{inputs.max_trials}}]]
  $[[--max_concurrent_trials ${{inputs.max_concurrent_trials}}]]
  $[[--sampling_algorithm ${{inputs.sampling_algorithm}}]]
  $[[--early_termination_policy ${{inputs.early_termination}}]]
  --model_name  ${{inputs.model_name}}
  $[[--learning_rate  s${{inputs.learning_rate}}]]
  $[[--number_of_epochs ${{inputs.number_of_epochs}}]]
  --optimizer ${{inputs.optimizer}}
  --model_size ${{inputs.yolov5_model_size}}
  --img_size ${{inputs.yolov5_img_size}}
  --min_size ${{inputs.min_size}}
  --max_size ${{inputs.max_size}}
  $[[--training_batch_size ${{inputs.training_batch_size}}]]
  $[[--validation_batch_size ${{inputs.validation_batch_size}}]]
  --weight_decay ${{inputs.weight_decay}}
  --sweep_json ${{outputs.sweep_json}}

distribution:
  type: pytorch
